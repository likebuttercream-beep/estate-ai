import { NextRequest, NextResponse } from 'next/server';

export async function POST(req: NextRequest) {
  try {
    const { area, price, location, tone, images } = await req.json();

    if (!process.env.GEMINI_API_KEY) {
      return NextResponse.json(
        { error: 'GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' },
        { status: 500 }
      );
    }

    // í†¤ë³„ ì „ë¬¸ê°€ í”„ë¡¬í”„íŠ¸
    let expertPrompt = '';
    
    if (tone === 'professional') {
      expertPrompt = `ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ í”„ë¦¬ë¯¸ì—„ ë¶€ë™ì‚° ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.

ì‘ì„± ì›ì¹™:
- ì •í™•í•œ ì…ì§€ ë¶„ì„ê³¼ ì‹œì¥ ê°€ì¹˜ í‰ê°€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±
- êµí†µ, í¸ì˜ì‹œì„¤, í•™êµ°, ê°œë°œí˜¸ì¬ ë“± êµ¬ì²´ì  ì •ë³´ í¬í•¨
- ì „ë¬¸ ìš©ì–´ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš© (ì—­ì„¸ê¶Œ, ì±„ê´‘, ë™ì„ , í‰í˜•)
- ê°ê´€ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” í†¤ ìœ ì§€
- ì´ëª¨ì§€ ì‚¬ìš© ìµœì†Œí™” (1-2ê°œë§Œ)

ì˜ˆì‹œ:
"${location} ì—­ì„¸ê¶Œ ${area} í”„ë¦¬ë¯¸ì—„ ì£¼ê±° ê³µê°„
${price}

ì…ì§€ ë¶„ì„:
- ì§€í•˜ì²  ë„ë³´ 3ë¶„ ê±°ë¦¬, ì¶œí‡´ê·¼ ìµœì í™”
- ëŒ€í˜•ë§ˆíŠ¸, ë°±í™”ì  ì¸ì ‘ìœ¼ë¡œ ìƒí™œ í¸ì˜ì„± ìš°ìˆ˜
- ë‚¨í–¥ ìœ„ì£¼ ì„¤ê³„ë¡œ ì±„ê´‘ê³¼ í†µí’ íƒì›”

ì‹¤ë‚´ íŠ¹ì§•:
- ê°œë°©í˜• ê±°ì‹¤ êµ¬ì¡°ë¡œ ê³µê°„ í™œìš©ë„ ë†’ìŒ
- ìµœì‹  ì‹œìŠ¤í…œ ì—ì–´ì»¨ ë° ë³´ì¼ëŸ¬ ì„¤ì¹˜
- ì „ ì„¸ëŒ€ ë¹„ë°, ë“œë ˆìŠ¤ë£¸ ê¸°ë³¸ ì œê³µ

ê´€ë¦¬ ìƒíƒœ ìš°ìˆ˜, ì¦‰ì‹œ ì…ì£¼ ê°€ëŠ¥í•©ë‹ˆë‹¤."`;
      
    } else if (tone === 'friendly') {
      expertPrompt = `ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì†Œí†µì„ ì¤‘ì‹œí•˜ëŠ” ë¶€ë™ì‚° ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì‘ì„± ì›ì¹™:
- ì‹¤ê±°ì£¼ì ê´€ì ì—ì„œ ì¼ìƒì˜ í¸ë¦¬í•¨ ê°•ì¡°
- êµ¬ì²´ì ì¸ ìƒí™œ ì‹œë‚˜ë¦¬ì˜¤ ì œì‹œ ("ì•„ì¹¨ì— ì—­ê¹Œì§€ ê±¸ì–´ê°€ë©´...")
- ë”°ëœ»í•˜ê³  ì§„ì •ì„± ìˆëŠ” í†¤
- ì´ëª¨ì§€ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš© (3-4ê°œ)

ì˜ˆì‹œ:
"âœ¨ ${location} ë°”ë¡œ ì½”ì•! ${area} ë”°ëœ»í•œ ì§‘

ğŸ’° ${price}

ğŸš‡ ì¶œí‡´ê·¼ì´ ì´ë ‡ê²Œ í¸í•  ìˆ˜ê°€!
ì•„ì¹¨ì— ì—¬ìœ ë¡­ê²Œ ì»¤í”¼ í•œ ì” í•˜ê³  ë‚˜ì™€ë„ ì—­ê¹Œì§€ 5ë¶„ì´ë©´ ë„ì°©í•´ìš”.

ğŸ  ì‹¤ì œë¡œ ì‚´ì•„ë³´ë©´ ì´ëŸ° ì ì´ ì¢‹ì•„ìš”:
- ë‚¨í–¥ì´ë¼ ë‚®ì—ëŠ” ì¡°ëª… ì¼¤ ì¼ì´ ê±°ì˜ ì—†ì–´ìš”
- ì£¼ë°©ì´ ë„“ì–´ì„œ ìš”ë¦¬í•˜ê¸° ì •ë§ í¸í•´ìš”
- ìˆ˜ë‚©ê³µê°„ì´ ë§ì•„ì„œ ì§‘ì´ í•­ìƒ ê¹”ë”í•´ìš”

ì£¼ë³€ì— ë§ˆíŠ¸, ì¹´í˜, ë³‘ì› ë‹¤ ìˆì–´ì„œ ìƒí™œí•˜ê¸° ë”±ì´ì—ìš” ğŸ˜Š
ê´€ë¦¬ ì˜ ëœ ì§‘ì´ë¼ ë³´ì‹œë©´ ë§ˆìŒì— ë“œì‹¤ ê±°ì˜ˆìš”!"`;
      
    } else if (tone === 'luxury') {
      expertPrompt = `ë‹¹ì‹ ì€ í•˜ì´ì—”ë“œ ë¶€ë™ì‚°ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ëŸ­ì…”ë¦¬ í”„ë¡œí¼í‹° ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.

ì‘ì„± ì›ì¹™:
- í’ˆê²©ê³¼ ê°€ì¹˜ë¥¼ ì¤‘ì‹œí•˜ëŠ” í‘œí˜„ ì‚¬ìš©
- ë¼ì´í”„ìŠ¤íƒ€ì¼ê³¼ ìŠ¤í…Œì´í„°ìŠ¤ ê°•ì¡°
- ë…ì ì„±ê³¼ í¬ì†Œì„± ì•”ì‹œ
- ìš°ì•„í•˜ê³  ì ˆì œëœ í†¤ ìœ ì§€
- ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ì´ëª¨ì§€ ì„ ë³„ ì‚¬ìš© (âœ¨ğŸ’ğŸ›ï¸)

ì˜ˆì‹œ:
"âœ¨ ${location} í”„ë¦¬ë¯¸ì—„ ë ˆì§€ë˜ìŠ¤

${area} | ${price}

ì…ì§€ì˜ ê°€ì¹˜
ë„ì‹¬ ì† í”„ë¼ì´ë¹—í•œ ì£¼ê±° í™˜ê²½ì„ ì¶”êµ¬í•˜ì‹œëŠ” ë¶„ë“¤ì„ ìœ„í•œ ê³µê°„ì…ë‹ˆë‹¤.
ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ê±°ì ê³¼ì˜ ì ‘ê·¼ì„±, ë¬¸í™” ì¸í”„ë¼ì™€ì˜ ê·¼ì ‘ì„±ì„ ëª¨ë‘ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤.

ê³µê°„ì˜ í’ˆê²©
ğŸ’ ë‚¨í–¥ ì „ë©´ ì±„ê´‘ìœ¼ë¡œ ìì—°ê´‘ì´ ê³µê°„ ì „ì²´ë¥¼ ì±„ì›ë‹ˆë‹¤
ğŸ’ ì²œì¥ê³ ì™€ ì°½í˜¸ ì‹œìŠ¤í…œì´ ë§Œë“¤ì–´ë‚´ëŠ” ê°œë°©ê°
ğŸ’ ë™ì„ ê³¼ ìˆ˜ë‚©ì„ ê³ ë ¤í•œ í”„ë¦¬ë¯¸ì—„ ì„¤ê³„

ìƒí™œì˜ ì§ˆì„ ì•„ì‹œëŠ” ë¶„ê»˜ ê¶Œí•´ë“œë¦½ë‹ˆë‹¤.
private viewing ê°€ëŠ¥í•©ë‹ˆë‹¤."`;
      
    } else {
      expertPrompt = `ë‹¹ì‹ ì€ ê· í˜•ì¡íŒ ì‹œê°ì„ ê°€ì§„ ë¶€ë™ì‚° ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì‘ì„± ì›ì¹™:
- ì •ë³´ ì „ë‹¬ê³¼ ê°ì„±ì˜ ê· í˜•
- í•µì‹¬ ì •ë³´ë¥¼ ê°„ê²°í•˜ê²Œ êµ¬ì¡°í™”
- ì „ë¬¸ì„±ê³¼ ì¹œê·¼í•¨ì„ ë™ì‹œì—
- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš© (2-3ê°œ)

ì˜ˆì‹œ:
"${location} ì—­ì„¸ê¶Œ ${area} ë§¤ë¬¼

${price}

ì£¼ìš” íŠ¹ì§•:
âœ… ì—­ ë„ë³´ 5ë¶„, í¸ì˜ì‹œì„¤ ì¶©ì‹¤
âœ… ë‚¨í–¥ êµ¬ì¡°, ì±„ê´‘ ìš°ìˆ˜
âœ… ê´€ë¦¬ ìƒíƒœ ì–‘í˜¸, ì¦‰ì‹œ ì…ì£¼ ê°€ëŠ¥

ì‹¤ë‚´ëŠ” ê¹”ë”í•˜ê²Œ ê´€ë¦¬ë˜ì–´ ìˆìœ¼ë©°, 
ì£¼ë°©ê³¼ ê±°ì‹¤ì´ ë¶„ë¦¬ë˜ì–´ ìˆì–´ ê³µê°„ í™œìš©ë„ê°€ ë†’ìŠµë‹ˆë‹¤.
ì£¼ë³€ ì¸í”„ë¼ê°€ ì˜ ê°–ì¶°ì ¸ ìˆì–´ ì‹¤ê±°ì£¼ì— ìµœì í™”ëœ ë§¤ë¬¼ì…ë‹ˆë‹¤."`;
    }

    // ì´ë¯¸ì§€ ë¶„ì„ ì§€ì‹œì‚¬í•­
    const imageInstructions = images && images.length > 0 ? `

[ì¤‘ìš”] ì—…ë¡œë“œëœ ${images.length}ì¥ì˜ ë§¤ë¬¼ ì‚¬ì§„ì„ ì •ë°€ ë¶„ì„í•˜ì—¬:

1. ê³µê°„ ë¶„ì„:
   - ì‹¤ì œ í‰ìˆ˜ ëŠë‚Œê³¼ ê³µê°„ê°
   - ê±°ì‹¤, ì£¼ë°©, ì¹¨ì‹¤ ë“± ê° ê³µê°„ì˜ íŠ¹ì§•
   - ì²œì¥ê³ , ì°½ë¬¸ í¬ê¸°, ì±„ê´‘ ìƒíƒœ

2. ì¸í…Œë¦¬ì–´ ë¶„ì„:
   - ë§ˆê°ì¬ ì¢…ë¥˜ì™€ ìƒíƒœ (íƒ€ì¼, ë§ˆë£¨, ë²½ì§€ ë“±)
   - ì¸í…Œë¦¬ì–´ ìŠ¤íƒ€ì¼ (ëª¨ë˜, í´ë˜ì‹, ë¯¸ë‹ˆë©€ ë“±)
   - ì£¼ë°©/ìš•ì‹¤ ì„¤ë¹„ ìƒíƒœ

3. ì»¨ë””ì…˜ í‰ê°€:
   - ì „ë°˜ì ì¸ ê´€ë¦¬ ìƒíƒœ
   - ë¦¬ëª¨ë¸ë§ ì—¬ë¶€
   - ì¦‰ì‹œ ì…ì£¼ ê°€ëŠ¥ ì—¬ë¶€

4. íŠ¹ë³„í•œ ì¥ì :
   - ë·° (ì°½ë°– í’ê²½)
   - ìˆ˜ë‚©ê³µê°„
   - ë² ë€ë‹¤/ë°œì½”ë‹ˆ
   - ê¸°íƒ€ ì°¨ë³„í™” í¬ì¸íŠ¸

** ì‚¬ì§„ì—ì„œ í™•ì¸ë˜ëŠ” êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì„¤ëª…ë¬¸ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì„¸ìš”.
** "ì‚¬ì§„ì„ ë³´ë‹ˆ", "ë³´ì‹œëŠ” ê²ƒì²˜ëŸ¼" ê°™ì€ í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.` : '';

    const fullPrompt = `${expertPrompt}

ë§¤ë¬¼ ì •ë³´:
- ìœ„ì¹˜: ${location}
- í‰ìˆ˜: ${area}
- ê°€ê²©: ${price}
${imageInstructions}

í•„ìˆ˜ ì¤€ìˆ˜ì‚¬í•­:
1. ê³¼ì¥ ê¸ˆì§€ - "íŒŒê²©", "ì ˆí˜¸", "ë†€ë¼ìš´" ë“± ì‚¬ìš© ë¶ˆê°€
2. ì••ë°• ê¸ˆì§€ - "ì§€ê¸ˆ ë°”ë¡œ", "ì„œë‘˜ëŸ¬" ë“± ì‚¬ìš© ë¶ˆê°€
3. êµ¬ì²´ì„± - ë§‰ì—°í•œ í‘œí˜„ë³´ë‹¤ êµ¬ì²´ì  ì •ë³´
4. ìì—°ìŠ¤ëŸ¬ì›€ - ê´‘ê³  ì¹´í”¼ê°€ ì•„ë‹Œ ì „ë¬¸ê°€ì˜ ì¡°ì–¸
5. ê¸¸ì´ - 4-6ì¤„ ì ì •, ìµœëŒ€ 8ì¤„

ì„¤ëª…ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš” (ë‹¤ë¥¸ ë§ í•˜ì§€ ë§ ê²ƒ):`;

    // Gemini API í˜¸ì¶œ
    const parts: Array<{ text?: string; inline_data?: { mime_type: string; data: string } }> = [{ text: fullPrompt }];
    
    if (images && images.length > 0) {
      (images as string[]).forEach((imageData: string) => {
        parts.push({
          inline_data: {
            mime_type: 'image/jpeg',
            data: imageData
          }
        });
      });
    }

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': process.env.GEMINI_API_KEY,
        },
        body: JSON.stringify({
          contents: [{ parts }]
        }),
      }
    );

    if (!response.ok) {
      const errorData = await response.text();
      console.error('Gemini API Error:', errorData);
      return NextResponse.json(
        { error: 'Gemini API ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
        { status: 500 }
      );
    }

    const data = await response.json();
    
    if (!data.candidates || !data.candidates[0]) {
      console.error('Unexpected response:', data);
      return NextResponse.json(
        { error: 'ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
        { status: 500 }
      );
    }

    const description = data.candidates[0].content.parts[0].text;

    return NextResponse.json({ description });
  } catch (error) {
    console.error('Error:', error);
    return NextResponse.json(
      { error: 'AI ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}